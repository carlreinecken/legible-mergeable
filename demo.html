<!doctype html>
<html>
    <head>
        <title>legibleMergeable Demo</title>
        <meta charset="UTF-8">
        <meta name="robots" content="noindex, nofollow">
        <style>
            * {
                box-sizing: border-box;
            }

            body {
                font-family: sans-serif;
            }

            .clients {
                display: flex;
                flex-wrap: wrap;
            }

            .client {
                border: 1px solid #bbb;
                width: 300px;
                min-height: 400px;
                padding: 10px;
                margin-right: 10px;
                margin-bottom: 10px;
            }

            .client > .newItem {
                padding: 10px 0;
                display: flex;
                justify-content: space-between;
            }

            .client .item {
                display: flex;
                justify-content: space-between;
                margin-bottom: 5px;
            }

            .sendMode > .client input,
            .sendMode > .client button {
                pointer-events: none;
                opacity: 0.5;
            }

            .sendMode > .client:hover {
                cursor: pointer;
                background-color: #93c2ff;
                border-color: #93c2ff;
            }

            header {
                display: flex;
                justify-content: space-between;
            }

            .stopSendMode {
                display: block;
            }
        </style>
    </head>

    <body>
        <div id="app">
            <button :disabled="sendFrom == null"
                    @click="stopSendMode()"
                    class=".stopSendMode">
                Stop Sending
            </button>

            <div class="clients" :class="{sendMode: sendFrom != null}">
                <div v-for="(client, clientIndex) in clients"
                     :key="client.name"
                     class="client"
                     @click="sendToClient(clientIndex)">
                    <header>
                        <h3 style="margin: 0">{{ client.name }}</h3>
                        <div>
                            <button @click="cloneClient(clientIndex)">Clone</button>
                            <button @click.stop="startSendMode(clientIndex)">Send</button>
                        </div>
                    </header>

                    <div class="newItem">
                        <input v-model="client.newItem" @keyup.enter="addItem(clientIndex)" />
                        <button @click="addItem(clientIndex)">Add</button>
                    </div>

                    <draggable :value="client.list.state()" @sort="(change) => onSort(clientIndex, change)">
                        <div class="item"
                             v-for="item in client.list.state()"
                             :key="client.name + item.id()"
                             :title="item.id()">
                            {{ item.get('title') }}
                            <button @click="deleteItem(clientIndex, item.id())">X</button>
                        </div>
                    </draggable>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.8.4/Sortable.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Vue.Draggable/2.20.0/vuedraggable.umd.min.js"></script>
        <script src="dist/legible-mergeable.js"></script>
        <script>
const app = new Vue({
    el: '#app',
    data: {
        sendFrom: null,
        clients: [],
        names: ['Alice', 'Bob', 'Carol', 'Dave', 'Eric', 'Florence']
    },

    mounted () {
        this.addClient()
    },

    methods: {
        onSort(clientIndex, change) {
            const base = this.clients[clientIndex].list.base()
            const id = base[change.oldIndex].id
            const k = (change.oldIndex > change.newIndex) ? change.newIndex - 1 : change.newIndex
            const afterId = k === -1 ? null : base[k].id

            // console.log('onSort', change.oldIndex, change.newIndex, id, afterId)
            this.clients[clientIndex].list.move(id, afterId)
            console.log(this.clients[clientIndex].list.meta()['^p'][id])
        },

        addClient (list) {
            const name = (this.names.length > 0) ? this.names.shift() : prompt('Client Name')
            if (!name) return
            this.clients.push({
                name,
                newItem: '',
                list: list || legibleMergeable.Array()
            })
        },

        cloneClient (clientIndex) {
            this.addClient(this.clients[clientIndex].list.clone())
        },

        stopSendMode () {
            this.sendFrom = null
        },

        startSendMode (clientIndex) {
            this.sendFrom = clientIndex
        },

        sendToClient (clientIndex) {
            if (this.sendFrom == null) return
            this.clients[clientIndex].list.merge(this.clients[this.sendFrom].list)
        },

        addItem (clientIndex) {
            const randomId = (length) => parseInt(Math.random().toString().slice(2, 2 + length)).toString(36)
            this.clients[clientIndex].list.push({
                id: randomId(5),
                title: this.clients[clientIndex].newItem
            })
            this.clients[clientIndex].newItem = ''
        },

        deleteItem (clientIndex, id) {
            this.clients[clientIndex].list.delete(id)
        }
    }
})
        </script>
    </body>
</html>
